package es.uv.eu.Ahorcado.model;

import java.awt.image.BufferedImage;
import java.io.IOException;
import java.util.HashSet;
import java.util.Set;
import javax.imageio.ImageIO;
import javax.swing.JOptionPane;

public class AhorcadoModel {
    private String palabraSecreta;
    private Set<Character> letrasUsadas;
    private int fallos;
    private int puntuacion;
    private BufferedImage imagenAhorcado;
    private int estiloActual = 0; // Sin estilo predefinido
    private static Persona[] p_vec = new Persona[10]; // Static para mantener entre instancias
    public static final int MAX_FALLOS = 5;
    private static int num_personas = 0;

    /*
     * Constructor del model sin parametros
     */
    public AhorcadoModel() {
         this.palabraSecreta = "";
    this.letrasUsadas = new HashSet<>();
    this.fallos = 0;
    this.puntuacion = 0;
    this.estiloActual = 0; // sin estilo

    cargarImagenInicio();  // ✅ SOLO la imagen de inicio
    }

    /*
     * Constructor del model con parametros
     */
    public AhorcadoModel(String palabra) {
        this.palabraSecreta = palabra.toUpperCase();
        this.letrasUsadas = new HashSet<>();
        this.fallos = 0;
        this.puntuacion = 0;

        // ✅ Si aún no se eligió estilo, pon uno por defecto para cargar Fallo0
        if (estiloActual == 0) estiloActual = 1;

        // ✅ Cargar imagen inicial (Fallo0) según el estilo
        cargarImagenSegunEstiloYFallos();
    }

    /**
     * ✅ Carga la imagen desde recursos:
     * /Estilos/EstiloX/FalloY.png
     *
     * OJO: tus archivos deben estar en Source Packages como:
     * Estilos/Estilo1/Fallo0.png
     */
    private void cargarImagenSegunEstiloYFallos() {
        if (estiloActual == 0) estiloActual = 2; // estilo por defecto
        if (fallos < 0) fallos = 0;
        if (fallos > MAX_FALLOS) fallos = MAX_FALLOS;

        String ruta = "/Estilos/Estilo" + estiloActual + "/Fallo" + fallos + ".png";

        try {
            var url = getClass().getResource(ruta);

            if (url != null) {
                imagenAhorcado = ImageIO.read(url);
            } else {
                crearImagenDeRespaldo("No encuentro " + ruta);
            }
        } catch (IOException e) {
            crearImagenDeRespaldo("Error cargando " + ruta);
        }
    }

    /**
     * Establece el estilo actual (1, 2 o 3)
     */
    
    public void setEstilo(int estilo) {
        if (estilo < 1 || estilo > 3) {
            throw new IllegalArgumentException("Estilo inválido");
        }

        this.estiloActual = estilo;

        // ✅ para que al cambiar estilo empiece en Fallo0
        this.fallos = 0;

        cargarImagenSegunEstiloYFallos();
    }

    /**
     * Procesa una letra introducida por el usuario.
     * La puntuación se incrementa en 1 por cada letra introducida (sea correcta o no).
     * 
     * @param letra Letra introducida por el usuario
     * @param estilo Estilo del dibujo (1, 2 o 3)
     * @return true si la letra está en la palabra, false si no está o ya fue usada
     */
    public boolean probarLetra(char letra, int estilo) {
        letra = Character.toUpperCase(letra);

        // Actualizar estilo si es diferente
        if (this.estiloActual != estilo) {
            setEstilo(estilo);
        }

        // Si la letra ya fue usada, no incrementar puntuación ni procesarla
        if (letrasUsadas.contains(letra)) {
            return false; // Letra ya usada
        }

        // Agregar la letra al conjunto de letras usadas
        letrasUsadas.add(letra);
        
        // Incrementar puntuación por cada letra introducida (nueva especificación)
        puntuacion++;

        // Verificar si la letra está en la palabra secreta
        if (!palabraSecreta.contains(String.valueOf(letra))) {
            // La letra NO está en la palabra: incrementar fallos
            fallos++;
            // Cargar nueva imagen según fallos
            cargarImagenSegunEstiloYFallos();
            return false;  // Acierto = false
        }
        
        // La letra SÍ está en la palabra
        return true;  // Acierto = true
    }

    /**
     * Versiones específicas por estilo
     */
    public boolean probarLetraEstilo1(char letra) {
        return probarLetra(letra, 1);
    }

    public boolean probarLetraEstilo2(char letra) {
        return probarLetra(letra, 2);
    }

    public boolean probarLetraEstilo3(char letra) {
        return probarLetra(letra, 3);
    }
    
    public boolean palabraCompletada() {
        // Recorre todas las letras de la palabra secreta:
        for (int i = 0; i < palabraSecreta.length(); i++) {
            char c = palabraSecreta.charAt(i);
            if (!letrasUsadas.contains(c)) {
                return false;
            }
        }
        return true;
    }


    /**
     * Crea imagen de respaldo
     */
    private void crearImagenDeRespaldo(String texto) {
        imagenAhorcado = new BufferedImage(400, 400, BufferedImage.TYPE_INT_ARGB);
        java.awt.Graphics2D g2d = imagenAhorcado.createGraphics();

        g2d.setColor(java.awt.Color.WHITE);
        g2d.fillRect(0, 0, 400, 400);
        g2d.setColor(java.awt.Color.BLACK);
        g2d.drawRect(0, 0, 399, 399);
        g2d.setColor(java.awt.Color.RED);
        g2d.setFont(new java.awt.Font("Arial", java.awt.Font.BOLD, 18));
        g2d.drawString(texto, 20, 200);
        g2d.dispose();
    }

    // GETTERS
    public BufferedImage getImagenAhorcado() {
        return imagenAhorcado;
    }

    public int getFallos() {
        return fallos;
    }

    public int getPuntuacion() {
        return puntuacion;
    }

    public Set<Character> getLetrasUsadas() {
        return letrasUsadas;
    }

    public String getPalabraSecreta() {
        return palabraSecreta;
    }

    public int getEstiloActual() {
        return estiloActual;
    }

    /**
     * Clase persona que contiene la informacion de una persona
     */
    public static class Persona{
        private int intentos;
        private int ganar;
        private String nombre;
        private static int num = 0;

        public Persona(String n, int ganar, int intentos){
            this.nombre = n;
            this.ganar = ganar;
            this.intentos = intentos;
            num++;
        }

        public String getNombre(){
            return this.nombre;
        }

        public int getIntentos(){
            return this.intentos;
        }

        public int getGanar(){
            return this.ganar;
        }

        public int getNum(){
            return num;
        }
    }

    /**
     * Funcion para agregar una persona en el array de jugadores
     * @param nombre nombre del jugador
     * @param ganar si ha ganado o perdido
     * @param veces cuantos intentos
     */
    public void agregarRanking(String nombre, int ganar, int veces){
        Persona p = new Persona(nombre, ganar, veces);
        Persona aux;

        p_vec[num_personas] = p;
        num_personas++;

        // Ordenar solo los elementos válidos (de 0 a num_personas-1)
        // Primero por intentos (menor es mejor), en caso de empate por ganar (ganador=1 antes que perdedor=0)
        for(int i = 0; i < num_personas - 1; i++){
            for(int j = i + 1; j < num_personas; j++){
                boolean debeIntercambiar = false;
                
                // Si el primero tiene más intentos que el segundo, intercambiar
                if(p_vec[i].getIntentos() > p_vec[j].getIntentos()) {
                    debeIntercambiar = true;
                }
                // Si tienen los mismos intentos, el ganador va primero
                else if(p_vec[i].getIntentos() == p_vec[j].getIntentos() 
                        && p_vec[i].getGanar() < p_vec[j].getGanar()) {
                    debeIntercambiar = true;
                }
                
                if(debeIntercambiar) {
                    aux = p_vec[i];
                    p_vec[i] = p_vec[j];
                    p_vec[j] = aux;
                }
            }
        }
    }

    public Persona[] mostrarRanking(){
        return p_vec;
    }
    
    public int getNumPersonas(){
        return num_personas;
    }
    
    private void cargarImagenInicio() {
        try {
            var url = getClass().getResource("/Inicio.png");
            if (url != null) {
                imagenAhorcado = ImageIO.read(url);
            } else {
                crearImagenDeRespaldo("No encuentro /Inicio.png");
            }
        } catch (IOException e) {
            crearImagenDeRespaldo("Error cargando Inicio.png");
        }
    }
}